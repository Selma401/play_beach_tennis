{% extends "base.html" %}
{% block title %}Torneios ‚Äî Play Beach Tennis{% endblock %}

{% block content %}
<section class="container">
  <div class="card page-header">
    <h1 class="page-title">üéæ Torneios Dispon√≠veis</h1>
    <p class="lead">Acompanhe torneios abertos, em andamento e encerrados.</p>
  </div>

  <div class="filter-row">
    <select id="filtroStatus" class="input-select small">
      <option value="todos">Todos</option>
      <option value="aberto">Abertos</option>
      <option value="em_andamento">Em Andamento</option>
      <option value="encerrado">Encerrados</option>
    </select>
  </div>

  <div id="listaTorneiosUsuario" class="torneios-list"></div>
</section>

<!-- MODAL DE INSCRI√á√ÉO -->
<div id="modalInscricao" class="modal-bg">
  <div class="modal-box">
    <h3>üìù Inscri√ß√£o no Torneio</h3>
    <p id="modalTorneioNome" style="font-weight:bold;"></p>

    <label for="formaPagamento">Forma de Pagamento:</label>
    <select id="formaPagamento" class="input-text" required>
      <option value="">Selecione...</option>
      <option value="pix">Pix</option>
      <option value="cartao_credito">Cart√£o de Cr√©dito</option>
      <option value="cartao_debito">Cart√£o de D√©bito</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="transferencia">Transfer√™ncia</option>
    </select>

    <label for="nivel">N√≠vel:</label>
    <select id="nivel" class="input-text" required>
      <option value="">Selecione...</option>
      <option value="iniciante">Iniciante</option>
      <option value="intermediario">Intermedi√°rio</option>
      <option value="avancado">Avan√ßado</option>
    </select>

    <label>Categoria:</label>
<select id="categoria">
  <option value="A">A</option>
  <option value="B">B</option>
  <option value="C">C</option>
</select>

<label>Tipo de Partida:</label>
<select id="tipo_partida">
  <option value="individual">Individual</option>
  <option value="dupla_masculina">Dupla Masculina</option>
  <option value="dupla_feminina">Dupla Feminina</option>
  <option value="dupla_mista">Dupla Mista</option>
</select>

    <div class="modal-actions">
      <button id="btnConfirmarInscricao" class="btn success">Confirmar</button>
      <button id="btnCancelarInscricao" class="btn secondary">Cancelar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  async function apiFetch(url, opts = {}) {
    opts.headers = { "Content-Type": "application/json" };
    opts.credentials = "include";
    if (opts.body && typeof opts.body !== "string") opts.body = JSON.stringify(opts.body);
    const res = await fetch(url, opts);
    try { return await res.json(); } catch { return []; }
  }

  const lista = document.getElementById("listaTorneiosUsuario");
  const filtroStatus = document.getElementById("filtroStatus");
  const modal = document.getElementById("modalInscricao");
  const btnCancelar = document.getElementById("btnCancelarInscricao");
  const btnConfirmar = document.getElementById("btnConfirmarInscricao");
  const formaPagamento = document.getElementById("formaPagamento");
  const nivel = document.getElementById("nivel");
  const modalNome = document.getElementById("modalTorneioNome");

  let torneioSelecionado = null;

  // Fun√ß√£o para abrir o modal corretamente
  window.abrirModalInscricao = (id, nome) => {
    torneioSelecionado = id;
    modalNome.textContent = nome;
    modal.classList.add("active");
  };

  // Cancelar
  btnCancelar.addEventListener("click", () => modal.classList.remove("active"));

  // Confirmar inscri√ß√£o
  btnConfirmar.addEventListener("click", async () => {
    if (!torneioSelecionado) return alert("Selecione um torneio.");
    if (!formaPagamento.value) return alert("Selecione a forma de pagamento.");
    if (!nivel.value) return alert("Selecione o n√≠vel.");

    const res = await apiFetch("/api/inscricao", {
  method: "POST",
  body: {
    torneio_id: torneioSelecionado,
    forma_pagamento: formaPagamento.value,
    nivel: nivel.value,
    categoria: document.getElementById("categoria").value,
    tipo_partida: document.getElementById("tipo_partida").value
  }
});

    alert(res.mensagem || res.erro || "Erro ao realizar inscri√ß√£o.");
    modal.classList.remove("active");
    carregarTorneios();
  });

  window.addEventListener("click", e => { if (e.target === modal) modal.classList.remove("active"); });

  async function carregarTorneios() {
    const filtro = filtroStatus.value;
    const torneios = await apiFetch("/api/torneios");
    lista.innerHTML = "";

    if (!torneios.length) {
      lista.innerHTML = "<p>Nenhum torneio encontrado.</p>";
      return;
    }

    torneios
      .filter(t => filtro === "todos" ? true : t.status === filtro)
      .forEach(t => {
        const card = document.createElement("div");
        card.className = "torneio-card";

        const statusBadge = {
          aberto: '<span class="badge badge-open">ABERTO</span>',
          em_andamento: '<span class="badge badge-live">EM ANDAMENTO</span>',
          encerrado: '<span class="badge badge-closed">ENCERRADO</span>'
        }[t.status] || "";

        const acoes = t.status === "aberto"
          ? `<button class="btn primary" onclick="abrirModalInscricao(${t.id}, '${t.nome}')">Inscrever-se</button>`
          : `<button class="btn secondary disabled">${t.status.replace("_"," ").toUpperCase()}</button>`;

        card.innerHTML = `
          <div class="t-meta">
            <h3>${t.nome}</h3>
            <p>üìÖ ${t.data_evento || '-'} | üí∞ R$ ${Number(t.preco || 0).toFixed(2)}</p>
            ${statusBadge}
          </div>
          <div class="t-actions">${acoes}</div>
        `;

        lista.appendChild(card);
      });
  }

  filtroStatus.addEventListener("change", carregarTorneios);
  carregarTorneios();
});

</script>

<style>
.modal-bg {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-bg.active {
  display: flex;
}

.modal-box {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 320px;
  max-width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.input-text {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 10px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}

.btn.success {
  background: #0E7C66;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
}

.btn.secondary {
  background: #ccc;
  color: #333;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
}
</style>
{% endblock %}
