{% extends "base.html" %}
{% block title %}üè† Painel ‚Äî Play Beach Tennis{% endblock %}

{% block content %}
<section class="container dashboard">
  <div class="welcome-card">
<h2>üëã Oi, <span style="color:#12533c;">{{ session.get('user_nome') }}</span>!</h2>
    <p>Bem-vindo(a) ao seu painel do Play Beach Tennis üèñÔ∏è</p>
  </div>

  <hr>

  <div class="painel-grid">
    <div class="card">
      <h3>üéæ Torneios Dispon√≠veis</h3>
      <ul id="torneios-list"></ul>
    </div>

    <div class="card">
      <h3>üìã Minhas Inscri√ß√µes</h3>
      <ul id="inscricoes-list"></ul>
    </div>
  </div>
</section>

<!-- MODAL DE INSCRI√á√ÉO -->
<div id="modalInscricao" class="modal-bg">
  <div class="modal-box">
    <h3>üìù Inscri√ß√£o no Torneio</h3>
    <p id="modalTorneioNome" style="font-weight:bold;"></p>

    <label for="formaPagamento">Forma de Pagamento:</label>
    <select id="formaPagamento" class="input-text" required>
      <option value="">Selecione...</option>
      <option value="pix">Pix</option>
      <option value="cartao_credito">Cart√£o de Cr√©dito</option>
      <option value="cartao_debito">Cart√£o de D√©bito</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="transferencia">Transfer√™ncia</option>
    </select>

    <label for="nivel">N√≠vel:</label>
    <select id="nivel" class="input-text" required>
      <option value="">Selecione...</option>
      <option value="iniciante">Iniciante</option>
      <option value="intermediario">Intermedi√°rio</option>
      <option value="avancado">Avan√ßado</option>
    </select>

    <label>Categoria:</label>
<select id="categoria">
  <option value="A">A</option>
  <option value="B">B</option>
  <option value="C">C</option>
</select>

<label>Tipo de Partida:</label>
<select id="tipo_partida">
  <option value="individual">Individual</option>
  <option value="dupla_masculina">Dupla Masculina</option>
  <option value="dupla_feminina">Dupla Feminina</option>
  <option value="dupla_mista">Dupla Mista</option>
</select>

    <div class="modal-actions">
      <button id="btnConfirmarInscricao" class="btn success">Confirmar</button>
      <button id="btnCancelarInscricao" class="btn secondary">Cancelar</button>
    </div>
  </div>
</div>

<style>
  .dashboard { max-width: 1000px; margin: 30px auto; }
.welcome-card {
  background: #007b55;
  color: #ffffff;
  padding: 28px;
  border-radius: 12px;
  text-align: center;
}

.welcome-card h2 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 6px;
  color: #ffffff; 
}

.welcome-card h2 span {
  color: #ffffff !important;
  font-weight: 800;
}

.welcome-card p {
  font-size: 20px;
  margin: 0;
  color: #e5fdf4;
}
  .painel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
  .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .card h3 { color: #007b55; margin-bottom: 10px; }
  ul { list-style: none; padding: 0; margin: 0; }
  li { background: #f5f5f5; margin-bottom: 8px; padding: 10px; border-radius: 6px; display: flex; flex-direction: column; gap: 4px; }
  .status { font-weight: bold; padding: 3px 8px; border-radius: 5px; display: inline-block; font-size: 0.85em; }
  .aberto { background: #d1fae5; color: #065f46; }
  .andamento { background: #fef3c7; color: #92400e; }
  .encerrado { background: #fee2e2; color: #991b1b; }
  button.inscrever-btn { background: #007b55; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-weight: 600; align-self: flex-start; }
  button.inscrever-btn:hover { background: #00a56d; }

  /* Modal */
  .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999; }
  .modal-bg.active { display: flex; }
  .modal-box { background: #fff; padding: 20px; border-radius: 10px; width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .input-text { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
  .btn.success { background: #0E7C66; color: #fff; border: none; padding: 6px 12px; border-radius: 8px; }
  .btn.secondary { background: #ccc; color: #333; border: none; padding: 6px 12px; border-radius: 8px; }
</style>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const modal = document.getElementById("modalInscricao");
  const modalNome = document.getElementById("modalTorneioNome");
  const formaPagamento = document.getElementById("formaPagamento");
  const nivel = document.getElementById("nivel");
  const btnCancelar = document.getElementById("btnCancelarInscricao");
  const btnConfirmar = document.getElementById("btnConfirmarInscricao");
  let torneioSelecionado = null;

  // Nome do usu√°rio logado
  const resSession = await fetch("/api/session-info");
  const userData = await resSession.json();
  if (resSession.ok && userData.user_name) {
    document.getElementById("user-name").textContent = userData.user_name;
  }

  // Carregar torneios
  async function carregarTorneios() {
    const res = await fetch("/api/torneios");
    const torneios = await res.json();
    const list = document.getElementById("torneios-list");
    list.innerHTML = "";

    if (!Array.isArray(torneios) || !torneios.length) {
      list.innerHTML = "<li>Nenhum torneio cadastrado.</li>";
      return;
    }

    torneios.forEach(t => {
      const li = document.createElement("li");
      const statusClass = t.status === "aberto" ? "aberto" :
                          (t.status === "em_andamento" ? "andamento" : "encerrado");

      li.innerHTML = `
        <strong>${t.nome}</strong>
        <small>üìÖ ${t.data_evento || "Data n√£o informada"}</small>
        <span class="status ${statusClass}">${t.status.replace("_", " ").toUpperCase()}</span>
        ${t.status === "aberto" ? `<button class="inscrever-btn" data-id="${t.id}" data-nome="${t.nome}">üìù Inscrever-se</button>` : ""}
      `;
      list.appendChild(li);
    });

    document.querySelectorAll(".inscrever-btn").forEach(btn => {
  btn.addEventListener("click", (e) => {
    const id = e.target.dataset.id;
    const nome = e.target.dataset.nome;

    // Armazena de forma segura
    torneioSelecionado = id;
    btnConfirmar.dataset.torneioId = id;

    modalNome.textContent = nome;
    modal.classList.add("active");
  });
});

  }

  // Cancelar modal
  btnCancelar.addEventListener("click", () => modal.classList.remove("active"));
  window.addEventListener("click", e => { if (e.target === modal) modal.classList.remove("active"); });

  // Confirmar inscri√ß√£o
  btnConfirmar.addEventListener("click", async () => {
    const id = btnConfirmar.dataset.torneioId || torneioSelecionado;
    if (!id) return alert("Erro: torneio n√£o identificado. Tente novamente.");

    if (!formaPagamento.value) return alert("Escolha uma forma de pagamento.");
    if (!nivel.value) return alert("Escolha seu n√≠vel.");

   const res = await fetch("/api/inscricao", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    torneio_id: id,
    forma_pagamento: formaPagamento.value,
    nivel: nivel.value,
    categoria: document.getElementById("categoria").value,
    tipo_partida: document.getElementById("tipo_partida").value
  })
});

    const data = await res.json();
    alert(data.mensagem || data.erro || "Erro ao realizar inscri√ß√£o.");
    modal.classList.remove("active");
    carregarInscricoes();
  }); // <-- este par√™ntese e ponto e v√≠rgula s√£o obrigat√≥rios


  // Carregar inscri√ß√µes
  async function carregarInscricoes() {
    const res = await fetch("/api/minhas_inscricoes");
    const inscricoes = await res.json();
    const list = document.getElementById("inscricoes-list");
    list.innerHTML = "";

    if (!Array.isArray(inscricoes) || !inscricoes.length) {
      list.innerHTML = "<li>Voc√™ ainda n√£o tem inscri√ß√µes.</li>";
      return;
    }

    inscricoes.forEach(i => {
      list.innerHTML += `
        <li>
          <strong>${i.torneio}</strong>
          <small>üí∞ ${i.forma_pagamento.toUpperCase()} ‚Äî R$ ${i.valor}</small>
          <small>üóìÔ∏è ${i.data_inscricao}</small>
        </li>`;
    });
  }

  await carregarTorneios();
  await carregarInscricoes();
});
</script>
{% endblock %}
{% endblock %}
