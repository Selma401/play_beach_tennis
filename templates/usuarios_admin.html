{% extends "base.html" %}
{% block title %}üë• Gerenciar Usu√°rios ‚Äî Play Beach Tennis{% endblock %}

{% block content %}
<section class="container dashboard">
  <div class="card tabela-card">
  <h2>üìã Lista de Usu√°rios</h2>

  <table class="tabela" id="tabelaUsuarios">
  <thead>
    <tr>
      <th>#</th>
      <th>Nome</th>
      <th>CPF</th>
      <th>Sexo</th>
      <th>Idade</th>
      <th>Telefone</th>
      <th>Cidade</th>
      <th>Estado</th>
      <th>Email</th>
      <th>A√ß√µes</th> <!-- ESTA LINHA FALTAVA -->
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>

<script src="/static/js/usuarios_admin.js"></script>

    <!-- Modal de Edi√ß√£o -->
  <div id="modal-edicao" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>‚úèÔ∏è Editar Usu√°rio</h3>
      <form id="formEdicao">
        <input type="hidden" id="edit-id">

        <label>Nome</label>
        <input type="text" id="edit-nome" required>

        <label>CPF</label>
        <input type="text" id="edit-cpf">

        <label>Sexo</label>
        <select id="edit-sexo">
          <option value="">Selecione</option>
          <option value="masculino">Masculino</option>
          <option value="feminino">Feminino</option>
        </select>

        <label>Idade</label>
        <input type="number" id="edit-idade" min="0">

        <label>Telefone</label>
        <input type="text" id="edit-telefone">

        <label>Cidade</label>
        <input type="text" id="edit-cidade">

        <label>Estado</label>
        <input type="text" id="edit-estado" maxlength="2" placeholder="UF (ex: MG)">

        <label>Email</label>
        <input type="email" id="edit-email" required>

        <div class="btn-group" style="margin-top:10px; display:flex; gap:8px;">
          <button type="submit" class="btn">üíæ Salvar</button>
          <button type="button" id="cancelarEdicao" class="btn secundario">Cancelar</button>
        </div>
      </form>
      <p id="msgEdicao" class="mensagem"></p>
    </div>
  </div>
</section>

<style>
  .dashboard { max-width: 1000px; margin: 30px auto; }
  .card, .welcome-card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .welcome-card { background: #007b55; color: white; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #007b55; color: #fff; }
  tr:nth-child(even) { background: #f7f7f7; }
  .btn { background: #007b55; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
  .btn:hover { background: #00a56d; }
  .secundario { background: #ccc; color: #333; }
  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  .btn-group { display: flex; gap: 10px; margin-top: 10px; }
</style>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tbody = document.querySelector("#tabelaUsuarios tbody");
  const modal = document.getElementById("modal-edicao");
  const form = document.getElementById("formEdicao");
  const msg = document.getElementById("msgEdicao");
  const cancelar = document.getElementById("cancelarEdicao");

  async function carregarUsuarios() {
    const res = await fetch("/api/usuarios");
    const usuarios = await res.json();
    tbody.innerHTML = "";

    usuarios.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
  <td>${u.id}</td>
  <td>${u.nome}</td>
  <td>${u.cpf || '-'}</td>
  <td>${u.sexo || '-'}</td>
  <td>${u.idade || '-'}</td>
  <td>${u.telefone || '-'}</td>
  <td>${u.cidade || '-'}</td>
  <td>${u.estado || '-'}</td>
  <td>${u.email}</td>
  <td>
    <button class="btn editar"
      data-id="${u.id}"
      data-nome="${u.nome}"
      data-email="${u.email}"
      data-cidade="${u.cidade || ''}"
      data-telefone="${u.telefone || ''}"
      data-cpf="${u.cpf || ''}"
      data-estado="${u.estado || ''}"
      data-sexo="${u.sexo || ''}"
      data-idade="${u.idade || ''}">
      ‚úè Editar
    </button>
    <button class="btn secundario excluir" data-id="${u.id}">üóë Excluir</button>
  </td>
`;

      tbody.appendChild(tr);
    });

    document.querySelectorAll(".editar").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const user = e.target.dataset;
        modal.style.display = "flex";
        document.getElementById("edit-id").value = user.id;
document.getElementById("edit-nome").value = user.nome;
document.getElementById("edit-email").value = user.email;
document.getElementById("edit-telefone").value = user.telefone;
document.getElementById("edit-cidade").value = user.cidade;
document.getElementById("edit-estado").value = user.estado;
document.getElementById("edit-cpf").value = user.cpf;
document.getElementById("edit-sexo").value = user.sexo;
document.getElementById("edit-idade").value = user.idade;
      });
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "";

    const id = document.getElementById("edit-id").value;
    const body = {
  nome: document.getElementById("edit-nome").value.trim(),
  email: document.getElementById("edit-email").value.trim(),
  telefone: document.getElementById("edit-telefone").value.trim(),
  cidade: document.getElementById("edit-cidade").value.trim(),
  estado: document.getElementById("edit-estado").value.trim(),
  idade: document.getElementById("edit-idade").value.trim(),
  sexo: document.getElementById("edit-sexo").value,
  cpf: document.getElementById("edit-cpf").value.trim()
};

    const res = await fetch(`/api/usuarios/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    msg.style.color = res.ok ? "#065f46" : "#b91c1c";
    msg.textContent = data.mensagem || data.erro;

    if (res.ok) {
      setTimeout(() => {
        modal.style.display = "none";
        carregarUsuarios();
      }, 800);
    }
  });

  cancelar.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

  await carregarUsuarios();
});
</script>
{% endblock %}
{% endblock %}